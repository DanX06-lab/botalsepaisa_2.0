<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Scan QR Code | Botalsepaisa</title>
    <link rel="stylesheet" href="styles/qr.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet" />
</head>

<body>
    <header class="header">
        <h1 class="logo">Botalsepaisa</h1>
    </header>
    <button class="back-dashboard-btn" onclick="location.href='user.html'">‚Üê Back to Dashboard</button>
    <main class="main-container">

        <section class="qr-scanner-section">
            <div class="scanner-frame" id="qr-reader">
                <!-- Camera feed will be injected here by JS or QR library -->
                <p class="scanner-placeholder">Camera preview will appear here</p>
            </div>

            <p class="instructions">Position the QR code inside the frame to scan automatically.</p>

            <div class="manual-input">
                <label for="qr-input">Or enter QR code manually</label>
                <input type="text" id="qr-input" name="qr-input" placeholder="Enter QR code here" />
                <button id="submit-btn">Submit</button>
            </div>
            <div class="upload-area">
                <input type="file" id="qr-file" accept="image/*" hidden />
                <button id="upload-btn" class="upload-btn">Upload QR Image</button>
                <span id="upload-name" class="upload-name" aria-live="polite"></span>
            </div>

            <!-- Optional preview -->
            <img id="qr-preview" class="qr-preview" alt="QR preview" style="display:none;" />


            <div class="scan-status" id="scan-status"></div>
        </section>
    </main>

    <footer class="footer">
        <p>¬© 2025 Botalsepaisa ¬∑ Transforming waste into wealth</p>
    </footer>

    <script>
        console.log('üöÄ Loading BotalSePaisa User QR Scanner...');

        // Load Socket.IO first (optional for real-time updates)
        function loadSocketIO() {
            const script = document.createElement('script');
            script.src = '/socket.io/socket.io.js';
            script.onload = function () {
                console.log('‚úÖ Socket.IO loaded');
                loadQRScanner();
            };
            script.onerror = function () {
                console.warn('‚ö†Ô∏è Socket.IO not available, loading from CDN...');
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
                cdnScript.onload = function () {
                    console.log('‚úÖ Socket.IO loaded from CDN');
                    loadQRScanner();
                };
                cdnScript.onerror = function () {
                    console.log('‚ÑπÔ∏è Socket.IO unavailable - continuing without real-time updates');
                    loadQRScanner(); // Load anyway without Socket.IO
                };
                document.head.appendChild(cdnScript);
            };
            document.head.appendChild(script);
        }

        // Load the html5-qrcode library
        function loadQRScanner() {
            // First load html5-qrcode
            const html5QrScript = document.createElement('script');
            html5QrScript.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
            html5QrScript.onload = function() {
                console.log(' html5-qrcode loaded');
                // Then load our custom scanner
                const qrScript = document.createElement('script');
                qrScript.src = 'js/qr-scanner.js';
                qrScript.onload = function() {
                    console.log(' User QR Scanner loaded');
                    updateConnectionStatus('ready', ' Ready to scan!');
                    // Initialize the scanner after it's loaded
                    if (window.qrScanner && window.qrScanner.init) {
                        window.qrScanner.init();
                    }
                };
                qrScript.onerror = function() {
                    console.error(' Failed to load QR scanner');
                    updateConnectionStatus('error', ' Scanner script failed to load');
                };
                document.head.appendChild(qrScript);
            };
            html5QrScript.onerror = function() {
                console.error(' Failed to load html5-qrcode');
                updateConnectionStatus('error', ' QR library failed to load');
            };
            document.head.appendChild(html5QrScript);
        }

        // Update connection status
        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connection-status');
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');

            if (statusIcon && statusText) {
                statusText.textContent = message;

                // Update icon based on status
                if (status === 'ready') {
                    statusIcon.textContent = 'üéØ';
                    statusDiv.className = 'connection-status ready';
                } else if (status === 'error') {
                    statusIcon.textContent = '‚ùå';
                    statusDiv.className = 'connection-status error';
                } else if (status === 'scanning') {
                    statusIcon.textContent = 'üì±';
                    statusDiv.className = 'connection-status scanning';
                } else {
                    statusIcon.textContent = 'üîÑ';
                    statusDiv.className = 'connection-status connecting';
                }
            }
        }

        // Start loading process
        updateConnectionStatus('connecting', 'üîÑ Loading scanner...');
        loadSocketIO();
    </script>
</body>

</html>